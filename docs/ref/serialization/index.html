<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.72">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Chialisp Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Chialisp Blog Atom Feed"><title data-react-helmet="true">CLVM Reference Manual | Chialisp</title><meta data-react-helmet="true" property="og:url" content="https://chialisp.com/docs/ref/serialization"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="CLVM Reference Manual | Chialisp"><meta data-react-helmet="true" name="description" content="Serialization"><meta data-react-helmet="true" property="og:description" content="Serialization"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://chialisp.com/docs/ref/serialization"><link data-react-helmet="true" rel="alternate" href="https://chialisp.com/docs/ref/serialization" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://chialisp.com/docs/ref/serialization" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.fb6aea02.css">
<link rel="preload" href="/assets/js/styles.e7753fea.js" as="script">
<link rel="preload" href="/assets/js/runtime~main.d0af800e.js" as="script">
<link rel="preload" href="/assets/js/main.79f0c603.js" as="script">
<link rel="preload" href="/assets/js/1.0bd0d2c4.js" as="script">
<link rel="preload" href="/assets/js/2.6e67f991.js" as="script">
<link rel="preload" href="/assets/js/3.e79e427a.js" as="script">
<link rel="preload" href="/assets/js/1be78505.5135d52c.js" as="script">
<link rel="preload" href="/assets/js/21.45426fa8.js" as="script">
<link rel="preload" href="/assets/js/935f2afb.63bb0b49.js" as="script">
<link rel="preload" href="/assets/js/17896441.c2bef226.js" as="script">
<link rel="preload" href="/assets/js/2f63d527.c4486165.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Chialisp</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a href="https://chia.net/blog" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Blog</a><a href="https://chia.net" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Chia.net</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/Chia-Network/chialisp-web" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_GrZ2"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.svg" alt="Chialisp Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">Chialisp</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a href="https://chia.net/blog" target="_blank" rel="noopener noreferrer" class="menu__link">Blog</a></li><li class="menu__list-item"><a href="https://chia.net" target="_blank" rel="noopener noreferrer" class="menu__link">Chia.net</a></li><li class="menu__list-item"><a href="https://github.com/Chia-Network/chialisp-web" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper main-docs-wrapper"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Chialisp</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">1 - CLVM Basics</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/doc2">2 - Coins, Spends and Wallets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/doc3">3 - Deeper into CLVM</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/doc4">4 - The High Level Language, Compiler, and Functions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/doc5">The Great Chia Glossary</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">CLVM</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/ref/clvm">1 - The CLVM</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/ref/serialization">2 - Serialization</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">FAQ</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/faq">ChiaLisp and CLVM FAQ</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">CLVM Reference Manual</h1></header><div class="markdown"><h2 id="serialization">Serialization</h2><p>The CLVM serialization format closely follows the in-memory representation of the program tree.</p><p>This in turn, closely resembles the text format of a fully compiled CLVM program.</p><p>At the lowest level, there are only three types of Object in the CLVM.</p><ul><li>Cons Cells</li><li>Values</li><li>Nil, a subtype of Value</li></ul><p>Each CLVM Object is represented by a series of one or more bytes. Each byte belongs to the representation of exactly one CLVM Object. That is, no bits in a byte are shared by multiple CLVM objects.</p><h3 id="values">Values</h3><p>Each value in the CLVM is an untyped sequence of bytes. In the running virtual machine, values have a property length, containing the number of bytes. The same concept is preserved in the serialization format. However, values must be distinguished from cons boxes in the byte stream, so an escaping scheme is used. This escaping means that serialized values using more than 7 bits have a different representation than the in memory representation.</p><p>Nil has a single predefined value which is not shared with any user-defined value.</p><h3 id="encoding">Encoding</h3><p>Values which can be represented in 7 bits are encoded as a single byte with that value. Larger serialized values are represented as a sequence of bytes that encode the size, and then the value bytes.</p><p>The encoding scheme for the size prefix is as follows:</p><p>The value of the first serialized byte determines the number of size bytes (1 to 6, including the first byte). The size then determines the number of bytes denoting the value (0 to 0x400000000-1 bytes long)</p><p><strong>size</strong> is the length of the byte array containing the value, as an integer.
In the table below, we use <strong>s</strong> to describe the bytes that make up the encoded size value, s[0] being the least significant byte of <strong>size</strong>. The size bytes are encoded MSB first.</p><pre><code>object is cons box:   0xFF
value == nil:         0x80
value &lt;= 0x7F:        value

size &lt; 0x40:          0x80 | s[0], value
size &lt; 0x2000:        0xC0 | s[1], s[0], value
size &lt; 0x100000:      0xE0 | s[2], s[1], s[0], value
size &lt; 0x8000000:     0xF0 | s[3], s[2], s[1], s[0], value
size &lt; 0x400000000:   0xF8 | s[4], s[3], s[2], s[1], s[0], value
</code></pre><p>In the table below, the bits marked x contain the length of the value array, in bytes.</p><h3 id="encoded-size-bytes-layout">Encoded Size bytes layout</h3><table><thead><tr><th>Size bytes</th><th>Min Value Len</th><th>Max Value Length</th><th>Byte 1</th><th>Byte 2</th><th>Byte 3</th><th>Byte 4</th><th>Byte 5</th></tr></thead><tbody><tr><td>1</td><td>0x00</td><td>0x3F</td><td>1xxxxxxx</td><td></td><td></td><td></td><td></td></tr><tr><td>2</td><td>0x40</td><td>0x1FFF</td><td>11xxxxxx</td><td>xxxxxxxx</td><td></td><td></td><td></td></tr><tr><td>3</td><td>0x2000</td><td>0xFFFFF</td><td>111xxxxx</td><td>xxxxxxxx</td><td>xxxxxxxx</td><td></td><td></td></tr><tr><td>4</td><td>0x100000</td><td>0x7FFFFFF</td><td>1111xxxx</td><td>xxxxxxxx</td><td>xxxxxxxx</td><td>xxxxxxxx</td><td></td></tr><tr><td>5</td><td>0x8000000</td><td>0x3FFFFFFFF</td><td>11111xxx</td><td>xxxxxxxx</td><td>xxxxxxxx</td><td>xxxxxxxx</td><td>xxxxxxxx</td></tr></tbody></table><h3 id="decoding">Decoding</h3><p>The decoding scheme is as follows:</p><p>c[0] is the first byte of the serialized CLVM object.</p><p><strong>size</strong> is the number of bytes contained in the value byte array
<strong>s</strong> is the byte array containing the bytes of the two&#x27;s complement integer size, the number of bytes in the value array.
<strong>value</strong> is the span of bytes describing the CLVM Object itself</p><p>c[0] can contain the entire value, or it can be part of the size header.
Values below 0x80 do not have size header bytes.</p><p>0x00-0x7f: A literal one byte value. c[0] contains the value.
<code>size = 1; value = c[0]</code></p><p>0x80-0xbf: The value starts at the byte c[1], and size is in the lower 6 bits of c[0]
<code>size = (c[0] &amp; 0x3F); value = c[1] .. c[size]</code></p><p>0xc0-0xdf: The value starts at c[2]; the lower 5 bits of c[0] are the high bits of size
<code>size = (c[0] &amp; 0x1F) .. c[1]; value = c[2] .. c[size+1]</code></p><p>0xe0-0xef: The value starts at c[3]; the lower 4 bits of c[0] are the high bits of size
<code>size = (c[0] &amp; 0x0F) .. c[2]; value = c[3] .. c[size+2]</code></p><p>0xf0-0xf7: The value starts at c[4]; the lower 3 bits of c[0] are the high bits of size
<code>size = (c[0] &amp; 0x07) .. c[3]; value = c[4] .. c[size+3]</code></p><p>0xf7-0xfb: The value starts at c[5]; the lower 2 bits of c[0] are the high bits of size
<code>size = (c[0] &amp; 0x03) .. c[4]; value = c[5] .. c[size+4]</code></p><p>Atoms of size 0x400000000 or greater are disallowed in the serialization format.</p><p>As an example:</p><pre><code>c = [ 0x84 0x33 0x22 0x11 0x00 ]
c[0] = 0x84
size = (0x84 &amp; 0x3F) = 4
value = [ 33 22 11 00 ]
</code></pre><p>In the above example, the length of the value is <strong>4</strong>, and we only needed the bottom 3 bits of the c[0] byte to encode the length, so the size is completely described by the first serialized byte. The total lenth of the encoded atom is 5 bytes.</p><p>Note that for values greater than 0x7F, the bytes of the serialized value representing the length are disjoint with the actual value bytes.</p><p>Let us consider some special cases.</p><pre><code>value(0x80) = 81 80
</code></pre><p>c[0] is <code>0x81</code>.Since c[0] is between <code>0x7F</code> and <code>0xC0</code>, we know that there is only one sie byte, c[0], and the value is contained in the following bytes, starting at c[1]. The total size of the value array is
<code>size</code> = <code>c[0] &amp; 0x3F</code> = <code>0x1</code>. So, the full value is contained in the single following byte.</p><pre><code>value(0x81) = 81 81
value(0x82) = 81 82
value(0xFF) = 81 ff
</code></pre><p>Note that the special byte 0xFF is allowed within the bytes representing a value.
0xFF denotes a cons box when it is the first byte of a decoded CLVM object, but it may also occur within the serialized bytes of a value.</p><p>A 2 byte value</p><pre><code>value(0x01FF) = 82 01 ff
</code></pre><h3 id="lists">Lists</h3><p>Lists are the primary high-level data structure in most LISP implementations. Traditionally, a LISP builds lists from cons boxes, a two-celled data structure that can be thought of as a struct with two fields, left and right, each of which contains either a value, or a (pointer to) another cons cell.</p><p>Because the cons cell is the low level data structure that lists are built from, LISP lists are only lists by way of the fact that lists can be implemented from trees. A lisp list built from cons cells in a binary tree.</p><p>Serialized cons cells are represented by the byte 0xFF, followed by the objects in its cells, left then right.
Values are represented by a variable length byte-aligned encoding scheme, described above.
Nil is chosen to be the zero-length object, which is represented by the byte 0x80.</p><p>Because lists are represented as a sequence of cons boxes, the byte 0xff occurs frequently in the serialization format.</p><p>After the FF introducer byte, the next two values describe what is in the left and right cons boxes, respectively.</p><p>The first examples use single byte values for clarity.</p><p>The list (1 2 3) will be encoded as:</p><pre><code>ff 01 ff 02 ff 03 80
</code></pre><p>This can be read as:</p><p><code>(a cons box containing 01</code> and <code>a cons box (containing 02</code> and <code>a cons box (containing 03 and nil)))</code></p><p>Alternatively, it could be viewed as a binary tree that looks like this:</p><pre><code>      [ ]
     /   \
    1    [ ]
         / \
        2  [ ]
           / \
          3  nil
</code></pre><p>Or, as a chain of memory cells that look like this:</p><pre><code>(a)[ 1, -&gt;b ]   (b)[ 2, -&gt;c ]   (c)[ 3, nil ]
</code></pre><p>Where</p><ul><li>(a) means &quot;The contents of the memory cells at position a and a+1 (cons box a)&quot;</li><li>-&gt;b means &quot;a pointer to cons box (b)&quot;</li><li><code>(a)</code>, <code>(b)</code>, <code>(c)</code> are arbitrary labels for the cons cells, and do not exist in the CLVM</li></ul><p>Because the above list contains only one level of nesting, a single <code>0x80</code> byte is sufficient to terminate the list. Note the two <code>0x80</code> bytes in the example below.</p><pre><code>opc &#x27;(1 (2 3))&#x27;
ff 01 ff ff 02 ff 03 80 80
</code></pre><p>There can be many cons cells in a CLVM program, so 0xFF will be common in the serialized program. There will be one serialized nil (0x80) per properly terminated list. Nil may also occur at other places in the program. There are usually more cons boxes than lists, so 0xFF occurs more frequently than 0x80.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/Chia-Network/chialisp-web/edit/master/docs/ref/serialization.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/ref/clvm"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« CLVM Reference Manual</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/faq"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">ChiaLisp and CLVM FAQ Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#serialization" class="table-of-contents__link">Serialization</a><ul><li><a href="#values" class="table-of-contents__link">Values</a></li><li><a href="#encoding" class="table-of-contents__link">Encoding</a></li><li><a href="#encoded-size-bytes-layout" class="table-of-contents__link">Encoded Size bytes layout</a></li><li><a href="#decoding" class="table-of-contents__link">Decoding</a></li><li><a href="#lists" class="table-of-contents__link">Lists</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">CLVM Basics</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/doc2/">Coins, Spends and Wallets</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://keybase.io/team/chia_network.public" target="_blank" rel="noopener noreferrer" class="footer__link-item">Keybase</a></li><li class="footer__item"><a href="https://twitter.com/chia_project" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.chia.net/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog</a></li><li class="footer__item"><a href="https://github.com/Chia-Network/clvm" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021 Chia Network Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/styles.e7753fea.js"></script>
<script src="/assets/js/runtime~main.d0af800e.js"></script>
<script src="/assets/js/main.79f0c603.js"></script>
<script src="/assets/js/1.0bd0d2c4.js"></script>
<script src="/assets/js/2.6e67f991.js"></script>
<script src="/assets/js/3.e79e427a.js"></script>
<script src="/assets/js/1be78505.5135d52c.js"></script>
<script src="/assets/js/21.45426fa8.js"></script>
<script src="/assets/js/935f2afb.63bb0b49.js"></script>
<script src="/assets/js/17896441.c2bef226.js"></script>
<script src="/assets/js/2f63d527.c4486165.js"></script>
</body>
</html>